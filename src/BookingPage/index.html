<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Booking Parking System</title>

  <!-- Google font -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet">

  <!-- Bootstrap 5 (use a single version) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet">

  <!-- Custom stylesheet (can contain overrides) -->
  <link type="text/css" rel="stylesheet" href="css/style.css" />
</head>

<body>
    <div id="booking" class="section">
        <div class="top-buttons">
            <button class="btn btn-primary" type="button"
                    data-bs-toggle="modal" data-bs-target="#loginModal">
                Login
            </button>
            <button class="btn btn-secondary" type="button"
                    data-bs-toggle="modal" data-bs-target="#registerModal">
                Register
            </button>
            </div>
        <div class="section-center">
            <div class="container">
                <div class="row">
                    <div class="booking-form">
                        <div class="form-header">
                            <h1>Book a Parking Spot</h1>
                        </div>
                        <form id="booking-form">
                            <!-- Start Date Selection -->
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <span class="form-label">First Name</span>
                                        <input class="form-control" name="FirstName" type="text" placeholder="Enter your first name" required>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <span class="form-label">Last Name</span>
                                        <input class="form-control" name="LastName" type="text" placeholder="Enter your last name" required>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <span class="form-label">Email</span>
                                <input class="form-control" name="Email" type="email" placeholder="Enter your email" required>
                            </div>
                            <div class="form-group">
                                <span class="form-label">Phone</span>
                                <input class="form-control" name="Phone" type="tel" placeholder="Enter your phone number" required>
                            </div>
                            <div class="form-group">
                                <span class="form-label"> Plate Number</span>
                                <input class="form-control" name="plateNum" type="plateNum" placeholder="Enter your plate number" required>
                            </div>
                            <div class="form-group">
                                <span class="form-label">Address</span>
                                <input class="form-control" name="UserAddress" type="text" placeholder="Enter your address" required>
                            </div>
                            <!-- Start of Start Date -->
                            <div class="row">
                                <div class="col-sm-5">
                                    <div class="form-group">
                                        <span class="form-label">Start Date</span>
                                        <input class="form-control" name="startDate" type="date" required>
                                    </div>
                                </div>
                                <div class="col-sm-7">
                                    <div class="row">
                                        <div class="col-sm-4">
                                            <div class="form-group">
                                                <span class="form-label">Hour</span>
                                                <select class="form-control" name="startHour">
                                                    <option>1</option>
                                                    <option>2</option>
                                                    <option>3</option>
                                                    <option>4</option>
                                                    <option>5</option>
                                                    <option>6</option>
                                                    <option>7</option>
                                                    <option>8</option>
                                                    <option>9</option>
                                                    <option>10</option>
                                                    <option>11</option>
                                                    <option>12</option>
                                                </select>
                                                <span class="select-arrow"></span>
                                            </div>
                                        </div>
                                        <div class="col-sm-4">
                                            <div class="form-group">
                                                <span class="form-label">Min</span>
                                                <select class="form-control" name="startMin">
                                                    <option>00</option>
                                                    <option>05</option>
                                                    <option>10</option>
                                                    <option>15</option>
                                                    <option>20</option>
                                                    <option>25</option>
                                                    <option>30</option>
                                                    <option>35</option>
                                                    <option>40</option>
                                                    <option>45</option>
                                                    <option>50</option>
                                                    <option>55</option>
                                                </select>
                                                <span class="select-arrow"></span>
                                            </div>
                                        </div>
                                        <div class="col-sm-4">
                                            <div class="form-group">
                                                <span class="form-label">AM/PM</span>
                                                <select class="form-control" name="start_ampm">
                                                    <option>AM</option>
                                                    <option>PM</option>
                                                </select>
                                                <span class="select-arrow"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                             <!-- End of Start -->

                            <!-- Start of End Date Selection -->
                            <div class="row">
                                <div class="col-sm-5">
                                    <div class="form-group">
                                        <span class="form-label">End Date</span>
                                        <input class="form-control" name="endDate" type="date" required>
                                    </div>
                                </div>
                                <div class="col-sm-7">
                                    <div class="row">
                                        <div class="col-sm-4">
                                            <div class="form-group">
                                                <span class="form-label">Hour</span>
                                                <select class="form-control" name="endHour">
                                                    <option>1</option>
                                                    <option>2</option>
                                                    <option>3</option>
                                                    <option>4</option>
                                                    <option>5</option>
                                                    <option>6</option>
                                                    <option>7</option>
                                                    <option>8</option>
                                                    <option>9</option>
                                                    <option>10</option>
                                                    <option>11</option>
                                                    <option>12</option>
                                                </select>
                                                <span class="select-arrow"></span>
                                            </div>
                                        </div>
                                        <div class="col-sm-4">
                                            <div class="form-group">
                                                <span class="form-label">Min</span>
                                                <select class="form-control" name="endMin">
                                                    <option>00</option>
                                                    <option>05</option>
                                                    <option>10</option>
                                                    <option>15</option>
                                                    <option>20</option>
                                                    <option>25</option>
                                                    <option>30</option>
                                                    <option>35</option>
                                                    <option>40</option>
                                                    <option>45</option>
                                                    <option>50</option>
                                                    <option>55</option>
                                                </select>
                                                <span class="select-arrow"></span>
                                            </div>
                                        </div>
                                        <div class="col-sm-4">
                                            <div class="form-group">
                                                <span class="form-label">AM/PM</span>
                                                <select class="form-control" name="end_ampm">
                                                    <option>AM</option>
                                                    <option>PM</option>
                                                </select>
                                                <span class="select-arrow"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                            <!-- End of End Date Selection -->



                            <!-- Parking Slot Selection -->
                            <div class="form-group">
                                <span class="form-label">Choose a parking slot</span>
                                <select class="form-control" name="slotId" required>
                                    <option value="1">Slot #1</option>
                                    <option value="2">Slot #2</option>
                                    <option value="3">Slot #3</option>
                                    <option value="4">Slot #4</option>
                                    <option value="5">Slot #5</option>
                                    <option value="6">Slot #6</option>
                                    <option value="7">Slot #7</option>
                                    <option value="8">Slot #8</option>
                                    <option value="9">Slot #9</option>
                                    <option value="10">Slot #10</option>
                                    <option value="11">Slot #11</option>
                                    <option value="12">Slot #12</option>
                                </select>
                                <span class="select-arrow"></span>
                            </div>
                            <!-- Payment Method Group  -->
                              <div class="form-group">
                                <span class="form-label">Total Cost</span>
                                <input type="text" class="form-control" id="TotalCostDisplay" name="TotalCost" readonly value="0">
                                <label id="costHint" class="text-muted">VND per hour</label>
                            </div>

                            <!-- Hidden for payment method, populated by modal -->
                            <input type="hidden" name="PayMethod" id="PayMethod">

                            <div class="form-btn">
                                <button class="submit-btn" type="submit">Book Now</button>
                            </div>

                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- LOGIN MODAL -->
        <!-- LOGIN MODAL -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="loginModalLabel">Customer Login</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="customerLoginForm">
          <div class="mb-3">
            <label for="loginEmail" class="form-label">Email</label>
            <input type="email" class="form-control" id="loginEmail" required>
          </div>
          <div class="mb-3">
            <label for="loginPassword" class="form-label">Password</label>
            <input type="password" class="form-control" id="loginPassword" required>
          </div>
          <button type="submit" class="btn btn-primary w-100">Login</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- REGISTER MODAL -->
<div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="registerModalLabel">Create Customer Account</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="customerRegisterForm">
          <div class="mb-3">
            <label for="regUsername" class="form-label">Username</label>
            <input type="text" class="form-control" id="regUsername" required>
          </div>
          <div class="mb-3">
            <label for="regEmail" class="form-label">Email</label>
            <input type="email" class="form-control" id="regEmail" required>
          </div>
          <div class="mb-3">
            <label for="regPassword" class="form-label">Password</label>
            <input type="password" class="form-control" id="regPassword" required>
          </div>
          <div class="mb-3">
            <label for="regVehType" class="form-label">Vehicle Type</label>
            <select class="form-control" id="regVehType" required>
              <option value="CAR">Car</option>
              <option value="MOTORBIKE">Motorbike</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="regPlateNum" class="form-label">Plate Number</label>
            <input type="text" class="form-control" id="regPlateNum" required>
          </div>
          <button type="submit" class="btn btn-success w-100">Register</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<div class="modal" tabindex="-1" id="paymentModal" style="display:none; position:fixed;
top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:30px; border-radius:10px; max-width:400px; margin:auto; text-align:center;">
    <h4>Select Payment Method</h4>
    <div id="modal-total-cost" style="font-weight:bold; margin-bottom:12px;">Total Cost: 0 VND</div>
    <button class="btn btn-secondary pay-method-btn" data-method="Credit Card">Credit Card</button><br>
    <button class="btn btn-secondary pay-method-btn" data-method="Online Banking">Online Banking</button><br>
    <button class="btn btn-success pay-method-btn" data-method="Pay In Cash">Pay in Cash</button>
    <br>
    <button id="cancelPaymentBtn" class="btn btn-link" style="margin-top:10px;">Cancel</button>
  </div>
</div>

  <script src="../BookingPage/bookingAuth.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let bookingPayload = null;
  const paymentModal     = document.getElementById('paymentModal');
  const payMethodInput   = document.getElementById('PayMethod');
  const totalCostDisplay = document.getElementById('TotalCostDisplay');
  const modalTotalCost   = document.getElementById('modal-total-cost');
  const form             = document.getElementById('booking-form');

  // Helper: Proper datetime
  function buildDateTime(dateStr, hourStr, minStr, ampm) {
    let hour = parseInt(hourStr, 10);
    if (ampm === 'PM' && hour < 12) hour += 12;
    if (ampm === 'AM' && hour === 12) hour = 0;
    const hourOut = hour.toString().padStart(2, "0");
    const minOut  = minStr.toString().padStart(2, "0");
    return `${dateStr} ${hourOut}:${minOut}:00`;
  }

  function calcTotalCost() {
    const startDT = buildDateTime(
      form.elements['startDate']?.value,
      form.elements['startHour']?.value || '0',
      form.elements['startMin']?.value  || '00',
      form.elements['start_ampm']?.value
    );
    const endDT = buildDateTime(
      form.elements['endDate']?.value,
      form.elements['endHour']?.value || '0',
      form.elements['endMin']?.value  || '00',
      form.elements['end_ampm']?.value
    );
    const start = new Date(startDT);
    const end   = new Date(endDT);
    if (isNaN(start.getTime()) || isNaN(end.getTime()) || end <= start) return 0;
    const msPerHour = 60 * 60 * 1000;
    const hours     = Math.ceil((end - start) / msPerHour);
    return hours * 5000; // 5k VND per hour
  }

  function updateTotalCostDisplay() {
    totalCostDisplay.value = calcTotalCost();
  }

  // Recalculate when time/date changes
  ['startDate','startHour','startMin','start_ampm',
   'endDate','endHour','endMin','end_ampm'].forEach(name => {
    const el = form.elements[name];
    if (el) el.addEventListener('change', updateTotalCostDisplay);
  });
  updateTotalCostDisplay();

  function buildPayload() {
    return {
      AreaID: 1, // or from a select if you add one
      SlotID: Number(form.elements['slotId']?.value ?? 0),
      FirstName:   (form.elements['FirstName']?.value   || '').trim(),
      LastName:    (form.elements['LastName']?.value    || '').trim(),
      Email:       (form.elements['Email']?.value       || '').trim(),
      Phone:       (form.elements['Phone']?.value       || '').trim(),
      UserAddress: (form.elements['UserAddress']?.value || '').trim(),
      StartTime: buildDateTime(
        form.elements['startDate']?.value,
        form.elements['startHour']?.value || '0',
        form.elements['startMin']?.value  || '00',
        form.elements['start_ampm']?.value
      ),
      EndTime: buildDateTime(
        form.elements['endDate']?.value,
        form.elements['endHour']?.value || '0',
        form.elements['endMin']?.value  || '00',
        form.elements['end_ampm']?.value
      ),
      TotalCost: Number(totalCostDisplay.value),
      PayMethod: '' // filled when user picks payment method
    };
  }

  function validatePayload(p) {
    const required = [
      'AreaID','SlotID','FirstName','LastName','Email',
      'Phone','UserAddress','StartTime','EndTime','TotalCost'
    ];
    for (const key of required) {
      if (p[key] == null || p[key] === '' || Number.isNaN(p[key])) {
        return { ok: false, message: `Missing or invalid field: ${key}` };
      }
    }
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(p.Email)) {
      return { ok: false, message: 'Invalid email format' };
    }
    const start = new Date(p.StartTime), end = new Date(p.EndTime);
    if (isNaN(start.getTime()) || isNaN(end.getTime())) {
      return { ok: false, message: 'StartTime or EndTime invalid' };
    }
    if (end <= start) {
      return { ok: false, message: 'EndTime must be after StartTime' };
    }
    if (p.TotalCost < 5000) {
      return { ok: false, message: 'Total cost too low' };
    }
    if (p.AreaID <= 0 || p.SlotID <= 0) {
      return { ok: false, message: 'AreaID and SlotID must be positive' };
    }
    return { ok: true };
  }

  // Show payment modal
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    bookingPayload = buildPayload();
    const valid = validatePayload(bookingPayload);
    if (!valid.ok) {
      alert(valid.message);
      return;
    }
    modalTotalCost.textContent = "Total Cost: " + bookingPayload.TotalCost + " VND";
    paymentModal.style.display = 'flex';
  });

  // Payment method + API call
  document.querySelectorAll('.pay-method-btn').forEach(button => {
    button.addEventListener('click', async function() {
      const selectedMethod = this.getAttribute('data-method');
      bookingPayload.PayMethod = selectedMethod;
      payMethodInput.value     = selectedMethod;
      paymentModal.style.display = 'none';

      try {
        const res = await fetch('http://localhost:3000/api/booking', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(bookingPayload)
        });

        const text = await res.text();
        console.log('Booking response raw:', text);
        let result;
        try {
          result = JSON.parse(text);
        } catch {
          alert('Server responded with non-JSON:\n' + text);
          return;
        }

        if (!res.ok || !result.success) {
          alert('Booking failed: ' + (result.error || `status ${res.status}`));
          return;
        }

        alert('Booking created: ' + (result.message || 'OK'));
        form.reset();
        updateTotalCostDisplay();
      } catch (err) {
        alert('Network error: ' + err.message);
      }
    });
  });

  document.getElementById('cancelPaymentBtn').onclick = function() {
    paymentModal.style.display = 'none';
  };
});
</script>

</body>
</html>
